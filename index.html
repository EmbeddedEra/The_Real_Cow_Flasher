<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>The Real Cow Flasher</title>
    <link rel="stylesheet" type="text/css" href="sakura-dark.css" />
    <script src="dfu.js"></script>
    <script src="dfuse.js"></script>
    <script src="dfu-util.js"></script>
    <style>
      p.warning, p.error { color: red; font-weight: bold; }
      label.radio { display: inline; }
      input:invalid { color: red; }
      #changelog { margin-top: 1em; color: #ccc; }
    </style>
  </head>
  <body>
    <h1>The Real Cow Flasher</h1>
    <span id="status"></span>
    <button id="connect">Connect</button>
    <div id="usbInfo" style="white-space: pre"></div>
    <div id="dfuInfo" style="white-space: pre"></div>
    <form id="configForm">
      <fieldset>
        <legend>Firmware</legend>
        <label for="firmwareVersion">Select firmware:</label>
        <select id="firmwareVersion" disabled>
          <option>Loading...</option>
        </select>
        <button id="download" disabled>Download</button>
        <div class="log" id="downloadLog"></div>
        <div id="changelog"></div>
      </fieldset>
    </form>
    <script>
      async function populateFirmwareDropdown() {
        try {
          const response = await fetch('firmware.json');
          const files = await response.json();
          const select = document.getElementById('firmwareVersion');
          select.innerHTML = '';
          if (files.length === 0) {
            select.innerHTML = '<option disabled>No firmware files found</option>';
          } else {
            files.forEach(file => {
              const option = document.createElement('option');
              option.value = `Firmware/${file}`;
              option.textContent = file;
              select.appendChild(option);
            });
            select.disabled = false;
          }
        } catch (e) {
          console.error('Failed to load firmware list:', e);
          const select = document.getElementById('firmwareVersion');
          select.innerHTML = '<option disabled>Error loading firmware list</option>';
        }
      }

      // Load changelog.json and show entry for selected firmware
      let changelogData = {};
      async function loadChangelog() {
        try {
          const response = await fetch('changelog.json');
          changelogData = await response.json();
        } catch (e) {
          changelogData = {};
        }
      }

      function showChangelogForSelected() {
        const select = document.getElementById('firmwareVersion');
        const changelogDiv = document.getElementById('changelog');
        if (!select || !changelogData) return;
        const selected = select.options[select.selectedIndex]?.textContent;
        if (selected && changelogData[selected]) {
          changelogDiv.textContent = 'Changelog: ' + changelogData[selected];
        } else {
          changelogDiv.textContent = '';
        }
      }

      window.addEventListener('DOMContentLoaded', async () => {
        await populateFirmwareDropdown();
        await loadChangelog();
        showChangelogForSelected();
        document.getElementById('firmwareVersion').addEventListener('change', showChangelogForSelected);
      });
    </script>
  </body>
</html>
